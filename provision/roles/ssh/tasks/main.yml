---
- stat: path=/vagrant/provision/files/ssh/id_rsa
  register: private_key_host

- stat: path=/vagrant/provision/files/ssh/id_rsa.pub
  register: public_key_host

- stat: path=/home/vagrant/.ssh/id_rsa
  register: private_key_guest

- stat: path=/home/vagrant/.ssh/id_rsa.pub
  register: public_key_guest

- file: path=/home/vagrant/.ssh state=directory mode=0700 owner=vagrant group=vagrant

- name: send private key to guest
  command: cp /vagrant/provision/files/ssh/id_rsa /home/vagrant/.ssh/
  when: private_key_host.stat.exists == True and vm.ssh.forward == '0'

- name: send private key to guest
  command: cp /vagrant/provision/files/ssh/id_rsa.pub /home/vagrant/.ssh/
  when: public_key_host.stat.exists == True and vm.ssh.forward == '0'

- file: path=/home/vagrant/.ssh/id_rsa.pub mode=0644 owner=vagrant group=vagrant
  when: public_key_guest.stat.exists == True

- file: path=/home/vagrant/.ssh/id_rsa mode=0600 owner=vagrant group=vagrant
  when: private_key_guest.stat.exists == True

- file: path=/home/vagrant/.ssh/authorized_keys mode=0600 state=touch owner=vagrant group=vagrant

#@todo This needs work
- shell: "cat /home/vagrant/.ssh/id_rsa.pub >> /home/vagrant/.ssh/authorized_keys"
  when: public_key_guest.stat.exists == True

- name: Make sure the known hosts file exists
  file: "path={{ vm.ssh.known_hosts_file }} state=touch"

- name: Scan the public key
  shell: "{{ vm.ssh.known_hosts_command}} {{ item }}"
  with_items: vm.ssh.known_hosts
  register: known_hosts

- lineinfile: dest={{ vm.ssh.known_hosts_file }} line="{{ known_hosts }}"
